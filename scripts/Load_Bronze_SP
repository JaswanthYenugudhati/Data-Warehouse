/*
This stored procedure automates the data loading process for all tables in the Bronze layer.
It truncates existing data and performs bulk inserts from source files into corresponding tables.
The procedure ensures consistent, repeatable ingestion of raw data from multiple sources.
It serves as the first step in the ETL pipeline, preparing data for transformation in the Silver layer.
*/

create or alter procedure bronze.load_bronze as 
begin
	declare @start_time Datetime , @end_time Datetime;
	begin try 
		print 'Loading Bronze Layer'
		print '////////////////////'

		print 'Loading CRM tables'

		print 'Truncating and reloading crm_cust_info'

		set @start_time = GETDATE();

		truncate table bronze.crm_cust_info
		bulk insert bronze.crm_cust_info
		from 'C:\Users\jaswa\OneDrive\Desktop\Data Warehouse\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_crm\cust_info.csv'
		with (
			firstrow = 2,
			fieldterminator = ',',
			tablock
		)

		set @end_time = GETDATE();

		print'';

		print '>> Load Duration : '+cast(datediff(second,@start_time,@end_time) as Nvarchar)+' seconds' ;

		print '';

		print 'Truncating and reloading crm_prd_info'
		
		set @start_time = getdate();

		truncate table bronze.crm_prd_info
		bulk insert bronze.crm_prd_info
		from 'C:\Users\jaswa\OneDrive\Desktop\Data Warehouse\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_crm\prd_info.csv'
		with (
			firstrow = 2,
			tablock,
			fieldterminator = ','
		);

		set @end_time = getdate();

		print'';
		print '>> Load Duration : '+cast(datediff(second,@start_time,@end_time) as Nvarchar)+' seconds' ;
		print'';

		print 'Truncating and reloading crm_sales_details'

		set @start_time = getdate();

		truncate table bronze.crm_sales_details
		bulk insert bronze.crm_sales_details
		from 'C:\Users\jaswa\OneDrive\Desktop\Data Warehouse\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_crm\sales_details.csv'
		with (
			firstrow = 2,
			tablock,
			fieldterminator = ','
		);

		set @end_time = GETDATE();

		print'';
		print '>> Load Duration : '+cast(datediff(second,@start_time,@end_time) as Nvarchar)+' seconds' ;
		print'';

		print '////////////////////'
		print 'Loading ERP tables' 


		print 'Truncating and reloading erp_cust_az12'

		set @start_time = GETDATE();

		truncate table bronze.erp_cust_az12
		bulk insert bronze.erp_cust_az12
		from 'C:\Users\jaswa\OneDrive\Desktop\Data Warehouse\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_erp\cust_az12.csv'
		with (
			firstrow = 2,
			tablock,
			fieldterminator = ','
		);

		set @end_time = GETDATE();

		print'';
		print '>> Load Duration : '+cast(datediff(second,@start_time,@end_time) as Nvarchar)+' seconds' ;
		print'';



		print 'Truncating and reloading erp_loc_a101'

		set @start_time = GETDATE();

		truncate table bronze.erp_loc_a101
		bulk insert bronze.erp_loc_a101
		from 'C:\Users\jaswa\OneDrive\Desktop\Data Warehouse\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_erp\loc_a101.csv'
		with (
			firstrow = 2,
			tablock,
			fieldterminator = ','
		);

		set @end_time = GETDATE();

		print'';
		print '>> Load Duration : '+cast(datediff(second,@start_time,@end_time) as Nvarchar)+' seconds' ;
		print'';

		print 'Truncating and reloading erp_px_cat_g1v2'

		set @start_time = GETDATE();

		truncate table bronze.erp_px_cat_g1v2
		bulk insert bronze.erp_px_cat_g1v2
		from 'C:\Users\jaswa\OneDrive\Desktop\Data Warehouse\sql-data-warehouse-project\sql-data-warehouse-project\datasets\source_erp\px_cat_g1v2.csv'
		with (
			firstrow = 2,
			tablock,
			fieldterminator = ','
		);

		set @end_time = GETDATE();

		print'';
		print '>> Load Duration : '+cast(datediff(second,@start_time,@end_time) as Nvarchar)+' seconds' ;
		print'';

	end try
	begin catch
		print'=============================='
		print 'Error Ocuured During Loading Bronze Layer'
		print 'Error Message ' + error_message();
		print'=============================='
	end catch
end;
